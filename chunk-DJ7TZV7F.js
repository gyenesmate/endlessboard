import{C as k,E as M,Mb as T,Ra as F,U as $,V as R,Wb as G,X as B,Z as E,_ as v,c as g,da as V,i as q,kc as U,o as K,wa as _}from"./chunk-HMJISF6U.js";import{c as w,d as y}from"./chunk-576YX7J7.js";var D=function(i){return i.readonly="readonly",i.readwrite="readwrite",i}(D||{}),Y=new B(null),z=new B("Indexed DB"),H=new B("Server Indexed DB");function J(i,h){return i.objectStoreNames.contains(h)}function S(i,h,e){if(!i){e("You need to use the openDatabase function to create a database before you query it!");return}J(i,h)||e(`objectStore does not exists: ${h}`)}function j(i,h){let e=i.transaction(h.storeName,h.dbMode);return e.onerror=h.error,e.onabort=h.abort,e}function b(i,h,e,r){return{storeName:h,dbMode:i,error:t=>{e(t)},abort:t=>{e(t)}}}var O=[];function x(i,h,e,r){return new Promise((t,n)=>{i||n("IndexedDB not available");let o=i.open(h,e),c;o.onsuccess=()=>{c=o.result,O.push(c),t(c)},o.onerror=()=>{n(`IndexedDB error: ${o.error}`)},typeof r=="function"&&(o.onupgradeneeded=s=>{r(s,c)})})}function P(i,h,e,r,t){return w(this,null,function*(){return new Promise((n,o)=>{if(!i)return;let c=i.open(h,e);c.onupgradeneeded=s=>w(null,null,function*(){let a=s.target.result,p=r.map(u=>w(null,null,function*(){if(!a.objectStoreNames.contains(u.store)){let l=a.createObjectStore(u.store,u.storeConfig);for(let f of u.storeSchema)l.createIndex(f.name,f.keypath,f.options)}}));yield Promise.all(p);let d=t&&t();if(d){let u=Object.keys(d).map(l=>parseInt(l,10)).filter(l=>l>s.oldVersion).sort((l,f)=>l-f);for(let l of u)d[l](a,c.transaction)}a.close(),n()}),c.onsuccess=s=>{s.target.result.close(),n()},c.onerror=s=>{o(s)}})})}function Q(i,h,e){if(!i||!h||!e)throw Error('Params: "dbName", "version", "storeName" are mandatory.');return new g(r=>{try{let t=h+1,n=indexedDB.open(i,t);n.onupgradeneeded=o=>{let c=o.target.result;c.deleteObjectStore(e),c.close(),console.log("onupgradeneeded"),r.next(),r.complete()},n.onerror=o=>r.error(o)}catch(t){r.error(t)}})}function W(i){return new Promise((h,e)=>{if(!i){e(new Error("No database to close"));return}try{i.close(),h()}catch(r){e(`Error closing database: ${r}`)}})}function m(){return function(i,h,e){let r=e.value;return e.value=function(...t){let n=r.apply(this,t);return n instanceof g?n.pipe(M(()=>w(this,null,function*(){let o=O.map(c=>w(this,null,function*(){yield W(c)}));yield Promise.all(o),O.length=0}))):n},e}}var Z=(()=>{class i{constructor(e,r){this.dbConfigs=e,this.indexedDB=r,this.defaultDatabaseName=null,Object.values(this.dbConfigs).forEach((t,n,o)=>this.instanciateConfig(t,o.length===1))}instanciateConfig(e,r){return w(this,null,function*(){if(!e.name)throw new Error("NgxIndexedDB: Please, provide the dbName in the configuration");if((e.isDefault??!1)&&this.defaultDatabaseName)throw new Error("NgxIndexedDB: Only one database can be set as default");((e.isDefault??!1)&&!this.defaultDatabaseName||r)&&(this.defaultDatabaseName=e.name,this.selectedDb=e.name),yield P(this.indexedDB,e.name,e.version,e.objectStoresMeta,e.migrationFactory),x(this.indexedDB,e.name).then(t=>{t.version!==e.version&&(T()&&(console.warn(`
            Your DB Config doesn't match the most recent version of the DB with name ${e.name}, please update it
            DB current version: ${t.version};
            Your configuration: ${e.version};
            `),console.warn(`Using latest version ${t.version}`)),this.dbConfigs[e.name].version=t.version),t.close()})})}get dbConfig(){return this.dbConfigs[this.selectedDb]}getDatabaseVersion(){return new g(e=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(r=>{e.next(r.version),e.complete()}).catch(r=>e.error(`error during get version of database => ${r} `))})}selectDb(e){if(e=e??this.defaultDatabaseName,!e)throw new Error("No database name specified and no default database set.");if(!Object.keys(this.dbConfigs).includes(e))throw new Error(`NgxIndexedDB: Database ${e} is not initialized.`);this.selectedDb=e}createObjectStore(e,r){return w(this,null,function*(){let t=[e];yield P(this.indexedDB,this.dbConfig.name,++this.dbConfig.version,t,r)})}createDynamicObjectStore(e,r){return w(this,null,function*(){let t=[e];yield P(this.indexedDB,this.dbConfig.name,this.dbConfig.version,t,r)})}add(e,r,t){return new g(n=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(o=>{let s=j(o,b(D.readwrite,e,d=>n.error(d))).objectStore(e),p=!!t?s.add(r,t):s.add(r);p.onsuccess=d=>w(this,null,function*(){let u=d.target.result,l=s.get(u);l.onsuccess=f=>{n.next(f.target.result),n.complete()},l.onerror=f=>{n.error(f)}}),p.onerror=d=>{n.error(d)}}).catch(o=>n.error(o))})}bulkAdd(e,r){let t=new Promise((n,o)=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(c=>{let a=j(c,b(D.readwrite,e,n,o)).objectStore(e),p=r.map(d=>new Promise(u=>{let l=d.key;delete d.key;let C=!!l?a.add(d,l):a.add(d);C.onsuccess=I=>{let X=I.target.result;u(X)}}));n(Promise.all(p))}).catch(c=>o(c))});return q(t)}bulkDelete(e,r){let t=r.map(n=>new Promise((o,c)=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(s=>{let a=j(s,b(D.readwrite,e,c,o));a.objectStore(e).delete(n),a.oncomplete=()=>{this.getAll(e).pipe(k(1)).subscribe(d=>{o(d)})}}).catch(s=>c(s))}));return q(Promise.all(t))}getByKey(e,r){return new g(t=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{let s=j(n,b(D.readonly,e,t.error)).objectStore(e).get(r);s.onsuccess=a=>{t.next(a.target.result),t.complete()},s.onerror=a=>{t.error(a)}}).catch(n=>t.error(n))})}bulkGet(e,r){let t=r.map(n=>this.getByKey(e,n));return new g(n=>{K(t).subscribe(o=>{n.next(o),n.complete()})})}getByID(e,r){return new g(t=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,a=>t.error(a));let s=j(n,b(D.readonly,e,t.error,t.next)).objectStore(e).get(r);s.onsuccess=a=>{t.next(a.target.result),t.complete()}}).catch(n=>t.error(n))})}getByIndex(e,r,t){return new g(n=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(o=>{S(o,e,d=>n.error(d));let p=j(o,b(D.readonly,e,n.error)).objectStore(e).index(r).get(t);p.onsuccess=d=>{n.next(d.target.result),n.complete()}}).catch(o=>n.error(o))})}getAll(e){return new g(r=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(t=>{S(t,e,s=>r.error(s));let c=j(t,b(D.readonly,e,r.error,r.next)).objectStore(e).getAll();c.onerror=s=>{r.error(s)},c.onsuccess=({target:{result:s}})=>{r.next(s),r.complete()}}).catch(t=>r.error(t))})}update(e,r){return new g(t=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,a=>t.error(a));let c=j(n,b(D.readwrite,e,a=>t.error(a))).objectStore(e),s=c.put(r);s.onsuccess=a=>w(this,null,function*(){let p=a.target.result,d=c.get(p);d.onsuccess=u=>{t.next(u.target.result),t.complete()}})}).catch(n=>t.error(n))})}bulkPut(e,r){let t;return new g(n=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(o=>{S(o,e,s=>n.error(s)),t=j(o,b(D.readwrite,e,s=>n.error(s)));let c=t.objectStore(e);r.forEach((s,a)=>{let p=c.put(s);a===r.length-1&&(p.onsuccess=d=>{t.commit(),n.next(d.target.result),n.complete()}),p.onerror=d=>{t.abort(),n.error(d)}})}).catch(o=>{t?.abort(),n.error(o)})})}delete(e,r){return new g(t=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,s=>t.error(s));let o=j(n,b(D.readwrite,e,s=>t.error(s)));o.objectStore(e).delete(r),o.onerror=s=>t.error(s),o.oncomplete=()=>{this.getAll(e).pipe(k(1)).subscribe({next:s=>{t.next(s)},error:s=>t.error(s),complete:()=>t.complete()})}}).catch(n=>t.error(n))})}deleteByKey(e,r){return new g(t=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,s=>t.error(s));let o=j(n,b(D.readwrite,e,s=>t.error(s)));o.objectStore(e).delete(r),o.onerror=s=>t.error(s),o.oncomplete=()=>{t.next(),t.complete()}}).catch(n=>t.error(n))})}deleteAllByIndex(e,r,t,n){return new g(o=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(c=>{S(c,e,u=>o.error(u));let d=j(c,b(D.readwrite,e,o.error)).objectStore(e).index(r).openCursor(t,n);d.onerror=u=>o.error(u),d.onsuccess=u=>{let l=u.target.result;l?(l.delete(),l.continue()):(o.next(),o.complete())}}).catch(c=>o.error(c))})}clear(e){return new g(r=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(t=>{S(t,e,c=>r.error(c));let n=j(t,b(D.readwrite,e,c=>r.error(c)));n.objectStore(e).clear(),n.onerror=c=>r.error(c),n.oncomplete=()=>{r.next(),r.complete()}}).catch(t=>r.error(t))})}deleteDatabase(){return new g(e=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(r=>w(this,null,function*(){r.close();let t=this.indexedDB.deleteDatabase(this.dbConfig.name);t.onsuccess=()=>{e.next(),e.complete()},t.onerror=n=>e.error(n),t.onblocked=()=>{console.warn("Delete blocked: Ensure all tabs, instances, or connections are closed. Database name:",this.dbConfig.name),e.error(new Error("Unable to delete database because it's blocked"))}})).catch(r=>e.error(r))})}openCursor(e){let{storeName:r,query:t,direction:n,mode:o=D.readonly}=e;return new g(c=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(s=>{S(s,r,u=>c.error(u));let a=j(s,b(o,r,c.error)),d=a.objectStore(r).openCursor(t,n);a.oncomplete=()=>c.complete(),d.onerror=u=>c.error(u),d.onsuccess=u=>{let l=u.target.result;l&&c.next(l)}}).catch(s=>c.error(s))})}openCursorByIndex(e){let{storeName:r,indexName:t,query:n,direction:o,mode:c=D.readonly}=e;return new g(s=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(a=>{S(a,r,f=>s.error(f));let p=j(a,b(c,r,s.error)),l=p.objectStore(r).index(t).openCursor(n,o);p.oncomplete=()=>s.complete(),l.onerror=f=>s.error(f),l.onsuccess=f=>{let C=f.target.result;C&&s.next(C)}}).catch(a=>s.error(a))})}getAllByIndex(e,r,t,n){return new g(o=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(c=>{S(c,e,l=>o.error(l));let d=j(c,b(D.readonly,e,o.error)).objectStore(e).index(r).openCursor(t,n),u=[];d.onerror=l=>o.error(l),d.onsuccess=l=>{let f=l.target.result;f?(u.push(f.value),f.continue()):(o.next(u),o.complete())}}).catch(c=>o.error(c))})}getAllKeysByIndex(e,r,t,n){return new g(o=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(c=>{S(c,e,l=>o.error(l));let p=j(c,b(D.readonly,e,o.error)).objectStore(e).index(r),d=[],u=p.openKeyCursor(t,n);u.onerror=l=>o.error(l),u.onsuccess=l=>{let f=l.target.result;if(f){let{primaryKey:C,key:I}=f;d.push({primaryKey:C,key:I}),f.continue()}else o.next(d),o.complete()}}).catch(c=>o.error(c))})}count(e,r){return new g(t=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(n=>{S(n,e,a=>t.error(a));let s=j(n,b(D.readonly,e,t.error)).objectStore(e).count(r);s.onerror=a=>t.error(a),s.onsuccess=a=>{t.next(a.target.result),t.complete()}}).catch(n=>t.error(n))})}countByIndex(e,r,t){return new g(n=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(o=>{S(o,e,d=>n.error(d));let p=j(o,b(D.readonly,e,n.error)).objectStore(e).index(r).count(t);p.onerror=d=>n.error(d),p.onsuccess=d=>{n.next(d.target.result),n.complete()}}).catch(o=>n.error(o))})}deleteObjectStore(e){return Q(this.dbConfig.name,++this.dbConfig.version,e)}getAllObjectStoreNames(){return new g(e=>{x(this.indexedDB,this.dbConfig.name,this.dbConfig.version).then(r=>{e.next(Array.from(r.objectStoreNames)),e.complete()}).catch(r=>e.error(r))})}static{this.\u0275fac=function(r){return new(r||i)(E(Y),E(z))}}static{this.\u0275prov=$({token:i,factory:i.\u0275fac})}}return y([m()],i.prototype,"getDatabaseVersion",null),y([m()],i.prototype,"add",null),y([m()],i.prototype,"bulkAdd",null),y([m()],i.prototype,"bulkDelete",null),y([m()],i.prototype,"getByKey",null),y([m()],i.prototype,"bulkGet",null),y([m()],i.prototype,"getByID",null),y([m()],i.prototype,"getByIndex",null),y([m()],i.prototype,"getAll",null),y([m()],i.prototype,"update",null),y([m()],i.prototype,"bulkPut",null),y([m()],i.prototype,"delete",null),y([m()],i.prototype,"deleteByKey",null),y([m()],i.prototype,"deleteAllByIndex",null),y([m()],i.prototype,"clear",null),y([m()],i.prototype,"deleteDatabase",null),y([m()],i.prototype,"openCursor",null),y([m()],i.prototype,"openCursorByIndex",null),y([m()],i.prototype,"getAllByIndex",null),y([m()],i.prototype,"getAllKeysByIndex",null),y([m()],i.prototype,"count",null),y([m()],i.prototype,"countByIndex",null),y([m()],i.prototype,"getAllObjectStoreNames",null),i})(),A=class{cmp(){return 0}databases(){return Promise.resolve([])}deleteDatabase(){return{onupgradeneeded:null,onblocked:null,onerror:null,onsuccess:null,error:null}}open(){return{onupgradeneeded:null,onblocked:null,onerror:null,onsuccess:null,error:null}}};function L(){V(L);let i=v(_),h=v(H,{optional:!0})??new A;return U(i)?v(G).defaultView.indexedDB:h}var N=(...i)=>{let h=i.reduce((e,r)=>(e[r.name]=r,e),{});return[Z,{provide:Y,useValue:h},{provide:z,useFactory:L}]},le=(()=>{class i{static forRoot(...e){return{ngModule:i,providers:[...N(...e)]}}static{this.\u0275fac=function(r){return new(r||i)}}static{this.\u0275mod=F({type:i})}static{this.\u0275inj=R({})}}return i})();export{Z as a,le as b};
